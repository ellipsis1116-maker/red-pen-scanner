<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå·åˆ†æ•°è¯†åˆ«å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        .video-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .detected-number {
            position: absolute;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #ff0000;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .flash-tip {
            animation: fadeOut 5s forwards;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .score-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 20;
            min-width: 120px;
            text-align: center;
        }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            color: white;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (prefers-color-scheme: dark) {
            .score-display {
                background: rgba(20, 20, 20, 0.9);
            }
        }
    </style>
</head>
<body class="bg-black overflow-hidden">
    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="text-xl mb-4">æ­£åœ¨åŠ è½½OCRæ¨¡å‹...</div>
        <div class="text-sm text-gray-300">é¦–æ¬¡ä½¿ç”¨éœ€è¦ä¸‹è½½çº¦2MBçš„è¯†åˆ«æ¨¡å‹</div>
    </div>

    <!-- é—ªå…‰ç¯æç¤º -->
    <div id="flashTip" class="flash-tip fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white px-6 py-3 rounded-lg text-lg font-bold z-20">
        è¯·æ‰“å¼€é—ªå…‰ç¯ä»¥è·å¾—æœ€ä½³æ•ˆæœ
    </div>

    <!-- è§†é¢‘å®¹å™¨ -->
    <div class="video-container">
        <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
        
        <!-- æ£€æµ‹åˆ°çš„æ•°å­—è¦†ç›–å±‚ -->
        <div id="overlay" class="overlay"></div>
    </div>

    <!-- åˆ†æ•°æ˜¾ç¤º -->
    <div id="scoreDisplay" class="score-display">
        <div class="text-sm opacity-75">æ€»åˆ†</div>
        <div id="totalScore" class="text-2xl">0</div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 flex gap-4 z-20">
        <button id="startBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold">
            å¼€å§‹è¯†åˆ«
        </button>
        <button id="resetBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-bold">
            é‡ç½®
        </button>
        <button id="toggleFlash" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-bold">
            é—ªå…‰ç¯
        </button>
    </div>

    <!-- çŠ¶æ€ä¿¡æ¯ -->
    <div id="statusInfo" class="fixed bottom-6 left-6 bg-black bg-opacity-60 text-white px-4 py-2 rounded-lg text-sm z-20">
        <div>æ£€æµ‹åˆ°: <span id="detectedCount">0</span> ä¸ªåˆ†æ•°</div>
        <div>è§’åº¦: <span id="angleStatus">è‰¯å¥½</span></div>
    </div>

    <!-- æ‘„åƒå¤´æƒé™æç¤º -->
    <div id="cameraPermission" class="fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center text-white z-40" style="display: none;">
        <div class="text-center max-w-md mx-4">
            <div class="text-6xl mb-4">ğŸ“¸</div>
            <h2 class="text-2xl font-bold mb-4">éœ€è¦æ‘„åƒå¤´æƒé™</h2>
            <p class="text-gray-300 mb-6">è¯·ç‚¹å‡»æµè§ˆå™¨åœ°å€æ çš„æ‘„åƒå¤´å›¾æ ‡ï¼Œç„¶åé€‰æ‹©"å…è®¸"æ¥ä½¿ç”¨æ‘„åƒå¤´åŠŸèƒ½ã€‚</p>
            <div class="text-sm text-gray-400 mb-6">
                <p>ç¡®ä¿æ‚¨çš„è®¾å¤‡å·²è¿æ¥æ‘„åƒå¤´ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«å…¶ä»–åº”ç”¨å ç”¨ã€‚</p>
            </div>
            <div class="flex gap-3">
                <button id="retryCamera" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold">
                    é‡æ–°å°è¯•
                </button>
                <button id="demoBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-bold">
                    æ¼”ç¤ºæ¨¡å¼
                </button>
            </div>
            <div id="errorDetails" class="mt-4 text-sm text-red-300"></div>
        </div>
    </div>

    <script>
        class ScoreRecognizer {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.overlay = document.getElementById('overlay');
                this.totalScore = 0;
                this.detectedNumbers = new Set();
                this.isProcessing = false;
                this.worker = null;
                this.stream = null;
                this.flashEnabled = false;
                
                this.init();
            }

            async init() {
                try {
                    // åˆå§‹åŒ–OCR
                    await this.initOCR();
                    
                    // å°è¯•å¯åŠ¨æ‘„åƒå¤´
                    await this.startCamera();
                    
                    // ç»‘å®šäº‹ä»¶
                    this.bindEvents();
                    
                    // éšè—åŠ è½½ç•Œé¢
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showCameraUnavailable(error);
                }
            }

            async initOCR() {
                this.worker = await Tesseract.createWorker('eng+chi_sim', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°åŠ è½½è¿›åº¦
                        }
                    }
                });
                
                await this.worker.setParameters({
                    tessedit_char_whitelist: '0123456789.',
                    tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT,
                });
            }

            async startCamera() {
                // æ£€æŸ¥æ˜¯å¦æ”¯æŒæ‘„åƒå¤´
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´è®¿é—®');
                }

                try {
                    // é¦–å…ˆå°è¯•åç½®æ‘„åƒå¤´
                    let constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };

                    try {
                        this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (envError) {
                        console.log('åç½®æ‘„åƒå¤´ä¸å¯ç”¨ï¼Œå°è¯•é»˜è®¤æ‘„åƒå¤´');
                        // å¦‚æœåç½®æ‘„åƒå¤´å¤±è´¥ï¼Œå°è¯•ä»»æ„æ‘„åƒå¤´
                        constraints = {
                            video: {
                                width: { ideal: 1920 },
                                height: { ideal: 1080 }
                            }
                        };
                        this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    }

                    this.video.srcObject = this.stream;
                    
                    this.video.onloadedmetadata = () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        console.log('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ');
                    };
                    
                } catch (error) {
                    console.error('æ‘„åƒå¤´è®¿é—®å¤±è´¥:', error);
                    throw error;
                }
            }

            showCameraUnavailable(error) {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('cameraPermission').style.display = 'flex';
                
                // æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
                const errorDetails = document.getElementById('errorDetails');
                if (error) {
                    errorDetails.textContent = `é”™è¯¯è¯¦æƒ…: ${error.message}`;
                }
            }

            bindEvents() {
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.startRecognition();
                });

                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.reset();
                });

                document.getElementById('toggleFlash').addEventListener('click', () => {
                    this.toggleFlashlight();
                });

                document.getElementById('demoBtn').addEventListener('click', () => {
                    this.startDemo();
                });

                document.getElementById('retryCamera').addEventListener('click', async () => {
                    document.getElementById('cameraPermission').style.display = 'none';
                    document.getElementById('loadingOverlay').style.display = 'flex';
                    document.getElementById('loadingOverlay').querySelector('.text-xl').textContent = 'æ­£åœ¨é‡æ–°å°è¯•æ‘„åƒå¤´...';
                    
                    try {
                        await this.startCamera();
                        document.getElementById('loadingOverlay').style.display = 'none';
                    } catch (error) {
                        this.showCameraUnavailable(error);
                    }
                });

                // éšè—é—ªå…‰ç¯æç¤º
                setTimeout(() => {
                    const flashTip = document.getElementById('flashTip');
                    if (flashTip) {
                        flashTip.style.display = 'none';
                    }
                }, 5000);
            }

            async toggleFlashlight() {
                try {
                    if (this.stream) {
                        const track = this.stream.getVideoTracks()[0];
                        const capabilities = track.getCapabilities();
                        
                        if (capabilities.torch) {
                            this.flashEnabled = !this.flashEnabled;
                            await track.applyConstraints({
                                advanced: [{ torch: this.flashEnabled }]
                            });
                            
                            const btn = document.getElementById('toggleFlash');
                            btn.textContent = this.flashEnabled ? 'å…³é—­é—ªå…‰ç¯' : 'é—ªå…‰ç¯';
                            btn.className = this.flashEnabled ? 
                                'bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-bold' :
                                'bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-bold';
                        }
                    }
                } catch (error) {
                    console.error('é—ªå…‰ç¯æ§åˆ¶å¤±è´¥:', error);
                }
            }

            startRecognition() {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                document.getElementById('startBtn').textContent = 'è¯†åˆ«ä¸­...';
                document.getElementById('startBtn').disabled = true;
                
                this.processFrame();
            }

            async processFrame() {
                if (!this.isProcessing) return;

                try {
                    // æ•è·å½“å‰å¸§
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    
                    // å¤„ç†çº¢è‰²åŒºåŸŸ
                    const redRegions = this.detectRedRegions();
                    
                    // è¯†åˆ«æ¯ä¸ªçº¢è‰²åŒºåŸŸä¸­çš„æ•°å­—
                    for (const region of redRegions) {
                        await this.recognizeNumberInRegion(region);
                    }
                    
                    // æ›´æ–°UI
                    this.updateUI();
                    
                    // ç»§ç»­å¤„ç†ä¸‹ä¸€å¸§
                    setTimeout(() => {
                        if (this.isProcessing) {
                            this.processFrame();
                        }
                    }, 500); // æ¯500mså¤„ç†ä¸€æ¬¡
                    
                } catch (error) {
                    console.error('å¤„ç†å¸§å¤±è´¥:', error);
                }
            }

            detectRedRegions() {
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const data = imageData.data;
                const regions = [];
                
                // ç®€åŒ–çš„çº¢è‰²æ£€æµ‹ç®—æ³•
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // æ£€æµ‹çº¢è‰²åƒç´  (çº¢è‰²å€¼é«˜ï¼Œç»¿è‰²å’Œè“è‰²å€¼ç›¸å¯¹è¾ƒä½)
                    if (r > 120 && r > g * 1.5 && r > b * 1.5) {
                        const pixelIndex = i / 4;
                        const x = pixelIndex % this.canvas.width;
                        const y = Math.floor(pixelIndex / this.canvas.width);
                        
                        // è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„åŒºåŸŸèšç±»ç®—æ³•
                        regions.push({ x, y, width: 30, height: 30 });
                    }
                }
                
                return this.mergeNearbyRegions(regions);
            }

            mergeNearbyRegions(regions) {
                // ç®€åŒ–çš„åŒºåŸŸåˆå¹¶ç®—æ³•
                const merged = [];
                const used = new Set();
                
                for (let i = 0; i < regions.length; i++) {
                    if (used.has(i)) continue;
                    
                    const region = regions[i];
                    let minX = region.x, minY = region.y;
                    let maxX = region.x + region.width, maxY = region.y + region.height;
                    
                    for (let j = i + 1; j < regions.length; j++) {
                        if (used.has(j)) continue;
                        
                        const other = regions[j];
                        const distance = Math.sqrt(
                            Math.pow(region.x - other.x, 2) + Math.pow(region.y - other.y, 2)
                        );
                        
                        if (distance < 50) { // 50åƒç´ å†…çš„åŒºåŸŸåˆå¹¶
                            minX = Math.min(minX, other.x);
                            minY = Math.min(minY, other.y);
                            maxX = Math.max(maxX, other.x + other.width);
                            maxY = Math.max(maxY, other.y + other.height);
                            used.add(j);
                        }
                    }
                    
                    merged.push({
                        x: minX,
                        y: minY,
                        width: maxX - minX,
                        height: maxY - minY
                    });
                    used.add(i);
                }
                
                return merged;
            }

            async recognizeNumberInRegion(region) {
                try {
                    // æå–åŒºåŸŸå›¾åƒ
                    const regionCanvas = document.createElement('canvas');
                    const regionCtx = regionCanvas.getContext('2d');
                    regionCanvas.width = region.width;
                    regionCanvas.height = region.height;
                    
                    regionCtx.drawImage(
                        this.canvas,
                        region.x, region.y, region.width, region.height,
                        0, 0, region.width, region.height
                    );
                    
                    // OCRè¯†åˆ«
                    const { data: { text } } = await this.worker.recognize(regionCanvas);
                    const cleanText = text.replace(/\s+/g, '').trim();
                    
                    // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
                    const number = this.parseScore(cleanText);
                    if (number !== null) {
                        const regionKey = `${Math.round(region.x / 10)}_${Math.round(region.y / 10)}`;
                        
                        if (!this.detectedNumbers.has(regionKey)) {
                            this.detectedNumbers.add(regionKey);
                            this.totalScore += number;
                            
                            // åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæ£€æµ‹åˆ°çš„æ•°å­—
                            this.showDetectedNumber(region, number);
                        }
                    }
                } catch (error) {
                    console.error('åŒºåŸŸè¯†åˆ«å¤±è´¥:', error);
                }
            }

            parseScore(text) {
                // åŒ¹é…æ•°å­—æ¨¡å¼: æ•´æ•°æˆ–å°æ•°
                const match = text.match(/^\d+(\.\d+)?$/);
                if (match) {
                    const num = parseFloat(match[0]);
                    // åˆç†çš„åˆ†æ•°èŒƒå›´æ£€æŸ¥
                    if (num >= 0 && num <= 100) {
                        return num;
                    }
                }
                return null;
            }

            showDetectedNumber(region, number) {
                const numberDiv = document.createElement('div');
                numberDiv.className = 'detected-number';
                numberDiv.textContent = number;
                
                // è½¬æ¢ä¸ºè§†é¢‘æ˜¾ç¤ºåæ ‡
                const videoRect = this.video.getBoundingClientRect();
                const scaleX = videoRect.width / this.canvas.width;
                const scaleY = videoRect.height / this.canvas.height;
                
                numberDiv.style.left = `${region.x * scaleX}px`;
                numberDiv.style.top = `${region.y * scaleY}px`;
                
                this.overlay.appendChild(numberDiv);
                
                // 3ç§’åç§»é™¤
                setTimeout(() => {
                    if (numberDiv.parentNode) {
                        numberDiv.parentNode.removeChild(numberDiv);
                    }
                }, 3000);
            }

            updateUI() {
                document.getElementById('totalScore').textContent = this.totalScore.toFixed(1);
                document.getElementById('detectedCount').textContent = this.detectedNumbers.size;
                
                // è§’åº¦çŠ¶æ€æ¨¡æ‹Ÿ
                const angleStatus = this.detectedNumbers.size > 3 ? 'è‰¯å¥½' : 'éœ€è¦è°ƒæ•´';
                document.getElementById('angleStatus').textContent = angleStatus;
                document.getElementById('angleStatus').className = 
                    angleStatus === 'è‰¯å¥½' ? 'text-green-400' : 'text-yellow-400';
            }

            reset() {
                this.totalScore = 0;
                this.detectedNumbers.clear();
                this.overlay.innerHTML = '';
                this.updateUI();
                
                this.isProcessing = false;
                document.getElementById('startBtn').textContent = 'å¼€å§‹è¯†åˆ«';
                document.getElementById('startBtn').disabled = false;
            }

            startDemo() {
                // æ¼”ç¤ºæ¨¡å¼ï¼šæ¨¡æ‹Ÿæ£€æµ‹åˆ°çš„åˆ†æ•°
                document.getElementById('cameraUnavailable').style.display = 'none';
                
                // åˆ›å»ºæ¨¡æ‹Ÿè§†é¢‘èƒŒæ™¯
                this.video.style.background = 'linear-gradient(45deg, #f0f0f0, #e0e0e0)';
                this.video.style.display = 'flex';
                this.video.style.alignItems = 'center';
                this.video.style.justifyContent = 'center';
                this.video.innerHTML = '<div style="color: #666; font-size: 24px; text-align: center;">æ¨¡æ‹Ÿè€ƒå·è§†å›¾<br><small>å®é™…ä½¿ç”¨æ—¶è¿™é‡Œä¼šæ˜¾ç¤ºæ‘„åƒå¤´ç”»é¢</small></div>';
                
                // æ¨¡æ‹Ÿæ£€æµ‹æ•°å­—
                setTimeout(() => {
                    this.simulateDetection(10, 50, 50);
                }, 1000);
                
                setTimeout(() => {
                    this.simulateDetection(8.5, 200, 150);
                }, 2000);
                
                setTimeout(() => {
                    this.simulateDetection(12, 350, 100);
                }, 3000);
            }

            simulateDetection(score, x, y) {
                const regionKey = `${Math.round(x / 10)}_${Math.round(y / 10)}`;
                if (!this.detectedNumbers.has(regionKey)) {
                    this.detectedNumbers.add(regionKey);
                    this.totalScore += score;
                    
                    const numberDiv = document.createElement('div');
                    numberDiv.className = 'detected-number';
                    numberDiv.textContent = score;
                    numberDiv.style.left = `${x}px`;
                    numberDiv.style.top = `${y}px`;
                    
                    this.overlay.appendChild(numberDiv);
                    this.updateUI();
                }
            }
        }

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new ScoreRecognizer();
        });

        // æ”¯æŒæ·±è‰²æ¨¡å¼
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</body>
</html>
