<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考卷分数识别工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        .video-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .detected-number {
            position: absolute;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #ff0000;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .flash-tip {
            animation: fadeOut 5s forwards;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .score-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 20;
            min-width: 120px;
            text-align: center;
        }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            color: white;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (prefers-color-scheme: dark) {
            .score-display {
                background: rgba(20, 20, 20, 0.9);
            }
        }
    </style>
</head>
<body class="bg-black overflow-hidden">
    <!-- 加载界面 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="text-xl mb-4">正在加载OCR模型...</div>
        <div class="text-sm text-gray-300">首次使用需要下载约2MB的识别模型</div>
    </div>

    <!-- 闪光灯提示 -->
    <div id="flashTip" class="flash-tip fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white px-6 py-3 rounded-lg text-lg font-bold z-20">
        请打开闪光灯以获得最佳效果
    </div>

    <!-- 视频容器 -->
    <div class="video-container">
        <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
        
        <!-- 检测到的数字覆盖层 -->
        <div id="overlay" class="overlay"></div>
    </div>

    <!-- 分数显示 -->
    <div id="scoreDisplay" class="score-display">
        <div class="text-sm opacity-75">总分</div>
        <div id="totalScore" class="text-2xl">0</div>
    </div>

    <!-- 控制按钮 -->
    <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 flex gap-4 z-20">
        <button id="startBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold">
            开始识别
        </button>
        <button id="resetBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-bold">
            重置
        </button>
        <button id="toggleFlash" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-bold">
            闪光灯
        </button>
    </div>

    <!-- 状态信息 -->
    <div id="statusInfo" class="fixed bottom-6 left-6 bg-black bg-opacity-60 text-white px-4 py-2 rounded-lg text-sm z-20">
        <div>检测到: <span id="detectedCount">0</span> 个分数</div>
        <div>角度: <span id="angleStatus">良好</span></div>
    </div>

    <!-- 摄像头权限提示 -->
    <div id="cameraPermission" class="fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center text-white z-40" style="display: none;">
        <div class="text-center max-w-md mx-4">
            <div class="text-6xl mb-4">📸</div>
            <h2 class="text-2xl font-bold mb-4">需要摄像头权限</h2>
            <p class="text-gray-300 mb-6">请点击浏览器地址栏的摄像头图标，然后选择"允许"来使用摄像头功能。</p>
            <div class="text-sm text-gray-400 mb-6">
                <p>确保您的设备已连接摄像头，并且没有被其他应用占用。</p>
            </div>
            <div class="flex gap-3">
                <button id="retryCamera" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-bold">
                    重新尝试
                </button>
                <button id="demoBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-bold">
                    演示模式
                </button>
            </div>
            <div id="errorDetails" class="mt-4 text-sm text-red-300"></div>
        </div>
    </div>

    <script>
        class ScoreRecognizer {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.overlay = document.getElementById('overlay');
                this.totalScore = 0;
                this.detectedNumbers = new Set();
                this.isProcessing = false;
                this.worker = null;
                this.stream = null;
                this.flashEnabled = false;
                
                this.init();
            }

            async init() {
                try {
                    // 初始化OCR
                    await this.initOCR();
                    
                    // 尝试启动摄像头
                    await this.startCamera();
                    
                    // 绑定事件
                    this.bindEvents();
                    
                    // 隐藏加载界面
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                } catch (error) {
                    console.error('初始化失败:', error);
                    this.showCameraUnavailable(error);
                }
            }

            async initOCR() {
                this.worker = await Tesseract.createWorker('eng+chi_sim', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            // 可以在这里更新加载进度
                        }
                    }
                });
                
                await this.worker.setParameters({
                    tessedit_char_whitelist: '0123456789.',
                    tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT,
                });
            }

            async startCamera() {
                // 检查是否支持摄像头
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('您的浏览器不支持摄像头访问');
                }

                try {
                    // 首先尝试后置摄像头
                    let constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };

                    try {
                        this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (envError) {
                        console.log('后置摄像头不可用，尝试默认摄像头');
                        // 如果后置摄像头失败，尝试任意摄像头
                        constraints = {
                            video: {
                                width: { ideal: 1920 },
                                height: { ideal: 1080 }
                            }
                        };
                        this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    }

                    this.video.srcObject = this.stream;
                    
                    this.video.onloadedmetadata = () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        console.log('摄像头启动成功');
                    };
                    
                } catch (error) {
                    console.error('摄像头访问失败:', error);
                    throw error;
                }
            }

            showCameraUnavailable(error) {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('cameraPermission').style.display = 'flex';
                
                // 显示具体错误信息
                const errorDetails = document.getElementById('errorDetails');
                if (error) {
                    errorDetails.textContent = `错误详情: ${error.message}`;
                }
            }

            bindEvents() {
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.startRecognition();
                });

                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.reset();
                });

                document.getElementById('toggleFlash').addEventListener('click', () => {
                    this.toggleFlashlight();
                });

                document.getElementById('demoBtn').addEventListener('click', () => {
                    this.startDemo();
                });

                document.getElementById('retryCamera').addEventListener('click', async () => {
                    document.getElementById('cameraPermission').style.display = 'none';
                    document.getElementById('loadingOverlay').style.display = 'flex';
                    document.getElementById('loadingOverlay').querySelector('.text-xl').textContent = '正在重新尝试摄像头...';
                    
                    try {
                        await this.startCamera();
                        document.getElementById('loadingOverlay').style.display = 'none';
                    } catch (error) {
                        this.showCameraUnavailable(error);
                    }
                });

                // 隐藏闪光灯提示
                setTimeout(() => {
                    const flashTip = document.getElementById('flashTip');
                    if (flashTip) {
                        flashTip.style.display = 'none';
                    }
                }, 5000);
            }

            async toggleFlashlight() {
                try {
                    if (this.stream) {
                        const track = this.stream.getVideoTracks()[0];
                        const capabilities = track.getCapabilities();
                        
                        if (capabilities.torch) {
                            this.flashEnabled = !this.flashEnabled;
                            await track.applyConstraints({
                                advanced: [{ torch: this.flashEnabled }]
                            });
                            
                            const btn = document.getElementById('toggleFlash');
                            btn.textContent = this.flashEnabled ? '关闭闪光灯' : '闪光灯';
                            btn.className = this.flashEnabled ? 
                                'bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-bold' :
                                'bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-bold';
                        }
                    }
                } catch (error) {
                    console.error('闪光灯控制失败:', error);
                }
            }

            startRecognition() {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                document.getElementById('startBtn').textContent = '识别中...';
                document.getElementById('startBtn').disabled = true;
                
                this.processFrame();
            }

            async processFrame() {
                if (!this.isProcessing) return;

                try {
                    // 捕获当前帧
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    
                    // 处理红色区域
                    const redRegions = this.detectRedRegions();
                    
                    // 识别每个红色区域中的数字
                    for (const region of redRegions) {
                        await this.recognizeNumberInRegion(region);
                    }
                    
                    // 更新UI
                    this.updateUI();
                    
                    // 继续处理下一帧
                    setTimeout(() => {
                        if (this.isProcessing) {
                            this.processFrame();
                        }
                    }, 500); // 每500ms处理一次
                    
                } catch (error) {
                    console.error('处理帧失败:', error);
                }
            }

            detectRedRegions() {
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const data = imageData.data;
                const regions = [];
                
                // 简化的红色检测算法
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // 检测红色像素 (红色值高，绿色和蓝色值相对较低)
                    if (r > 120 && r > g * 1.5 && r > b * 1.5) {
                        const pixelIndex = i / 4;
                        const x = pixelIndex % this.canvas.width;
                        const y = Math.floor(pixelIndex / this.canvas.width);
                        
                        // 这里可以实现更复杂的区域聚类算法
                        regions.push({ x, y, width: 30, height: 30 });
                    }
                }
                
                return this.mergeNearbyRegions(regions);
            }

            mergeNearbyRegions(regions) {
                // 简化的区域合并算法
                const merged = [];
                const used = new Set();
                
                for (let i = 0; i < regions.length; i++) {
                    if (used.has(i)) continue;
                    
                    const region = regions[i];
                    let minX = region.x, minY = region.y;
                    let maxX = region.x + region.width, maxY = region.y + region.height;
                    
                    for (let j = i + 1; j < regions.length; j++) {
                        if (used.has(j)) continue;
                        
                        const other = regions[j];
                        const distance = Math.sqrt(
                            Math.pow(region.x - other.x, 2) + Math.pow(region.y - other.y, 2)
                        );
                        
                        if (distance < 50) { // 50像素内的区域合并
                            minX = Math.min(minX, other.x);
                            minY = Math.min(minY, other.y);
                            maxX = Math.max(maxX, other.x + other.width);
                            maxY = Math.max(maxY, other.y + other.height);
                            used.add(j);
                        }
                    }
                    
                    merged.push({
                        x: minX,
                        y: minY,
                        width: maxX - minX,
                        height: maxY - minY
                    });
                    used.add(i);
                }
                
                return merged;
            }

            async recognizeNumberInRegion(region) {
                try {
                    // 提取区域图像
                    const regionCanvas = document.createElement('canvas');
                    const regionCtx = regionCanvas.getContext('2d');
                    regionCanvas.width = region.width;
                    regionCanvas.height = region.height;
                    
                    regionCtx.drawImage(
                        this.canvas,
                        region.x, region.y, region.width, region.height,
                        0, 0, region.width, region.height
                    );
                    
                    // OCR识别
                    const { data: { text } } = await this.worker.recognize(regionCanvas);
                    const cleanText = text.replace(/\s+/g, '').trim();
                    
                    // 验证是否为有效数字
                    const number = this.parseScore(cleanText);
                    if (number !== null) {
                        const regionKey = `${Math.round(region.x / 10)}_${Math.round(region.y / 10)}`;
                        
                        if (!this.detectedNumbers.has(regionKey)) {
                            this.detectedNumbers.add(regionKey);
                            this.totalScore += number;
                            
                            // 在界面上显示检测到的数字
                            this.showDetectedNumber(region, number);
                        }
                    }
                } catch (error) {
                    console.error('区域识别失败:', error);
                }
            }

            parseScore(text) {
                // 匹配数字模式: 整数或小数
                const match = text.match(/^\d+(\.\d+)?$/);
                if (match) {
                    const num = parseFloat(match[0]);
                    // 合理的分数范围检查
                    if (num >= 0 && num <= 100) {
                        return num;
                    }
                }
                return null;
            }

            showDetectedNumber(region, number) {
                const numberDiv = document.createElement('div');
                numberDiv.className = 'detected-number';
                numberDiv.textContent = number;
                
                // 转换为视频显示坐标
                const videoRect = this.video.getBoundingClientRect();
                const scaleX = videoRect.width / this.canvas.width;
                const scaleY = videoRect.height / this.canvas.height;
                
                numberDiv.style.left = `${region.x * scaleX}px`;
                numberDiv.style.top = `${region.y * scaleY}px`;
                
                this.overlay.appendChild(numberDiv);
                
                // 3秒后移除
                setTimeout(() => {
                    if (numberDiv.parentNode) {
                        numberDiv.parentNode.removeChild(numberDiv);
                    }
                }, 3000);
            }

            updateUI() {
                document.getElementById('totalScore').textContent = this.totalScore.toFixed(1);
                document.getElementById('detectedCount').textContent = this.detectedNumbers.size;
                
                // 角度状态模拟
                const angleStatus = this.detectedNumbers.size > 3 ? '良好' : '需要调整';
                document.getElementById('angleStatus').textContent = angleStatus;
                document.getElementById('angleStatus').className = 
                    angleStatus === '良好' ? 'text-green-400' : 'text-yellow-400';
            }

            reset() {
                this.totalScore = 0;
                this.detectedNumbers.clear();
                this.overlay.innerHTML = '';
                this.updateUI();
                
                this.isProcessing = false;
                document.getElementById('startBtn').textContent = '开始识别';
                document.getElementById('startBtn').disabled = false;
            }

            startDemo() {
                // 演示模式：模拟检测到的分数
                document.getElementById('cameraUnavailable').style.display = 'none';
                
                // 创建模拟视频背景
                this.video.style.background = 'linear-gradient(45deg, #f0f0f0, #e0e0e0)';
                this.video.style.display = 'flex';
                this.video.style.alignItems = 'center';
                this.video.style.justifyContent = 'center';
                this.video.innerHTML = '<div style="color: #666; font-size: 24px; text-align: center;">模拟考卷视图<br><small>实际使用时这里会显示摄像头画面</small></div>';
                
                // 模拟检测数字
                setTimeout(() => {
                    this.simulateDetection(10, 50, 50);
                }, 1000);
                
                setTimeout(() => {
                    this.simulateDetection(8.5, 200, 150);
                }, 2000);
                
                setTimeout(() => {
                    this.simulateDetection(12, 350, 100);
                }, 3000);
            }

            simulateDetection(score, x, y) {
                const regionKey = `${Math.round(x / 10)}_${Math.round(y / 10)}`;
                if (!this.detectedNumbers.has(regionKey)) {
                    this.detectedNumbers.add(regionKey);
                    this.totalScore += score;
                    
                    const numberDiv = document.createElement('div');
                    numberDiv.className = 'detected-number';
                    numberDiv.textContent = score;
                    numberDiv.style.left = `${x}px`;
                    numberDiv.style.top = `${y}px`;
                    
                    this.overlay.appendChild(numberDiv);
                    this.updateUI();
                }
            }
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            new ScoreRecognizer();
        });

        // 支持深色模式
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</body>
</html>
